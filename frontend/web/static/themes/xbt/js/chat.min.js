function createWebSocket(){try{ws=new WebSocket(window.WS_URL),initWebSocket()}catch(a){console.log("reconnect ws!!!"),reconnect(window.WS_URL)}}function initWebSocket(){ws.onopen=function(){$("#jam_chat_online").removeClass("jam_chat_online_off"),console.log("Client connected.\n"),heartCheck.reset().start(),connected=!0;var a={};a["uid"]=window.WS_UID,a["event"]="getMemberList",ws.send(JSON.stringify(a))},ws.onmessage=function(event){heartCheck.reset().start();var data=event.data;data=eval("("+data+")"),"sendMsgAll"==data.event?showMessage(data):"addMember"==data.event?addMember(data):"getMemberList"==data.event?addMemberList(data.memberList,data.memberCount):"deleteMember"==data.event?($("#member_"+data.uid).remove(),updateMemberCount(data["memberCount"])):"uncheck"==data.event&&(console.log("stop check.\n"),connected=!1,reconnectFlag=!0,heartCheck.reset())},ws.onclose=function(a){return $("#jam_chat_online").addClass("jam_chat_online_off"),console.log("Client has closed.\n"),1006==a.code?!1:(reconnect(),void 0)},ws.onerror=function(){$("#jam_chat_online").addClass("jam_chat_online_off"),console.log("Client error.\n")}}function reconnect(a){return reconnectFlag?!1:(reconnectFlag=!0,setTimeout(function(){createWebSocket(a),reconnectFlag=!1},2e3),void 0)}function showMessage(a){var b="";b+=a["fromUserId"]==window.WS_UID?'<li class="jam-chat-mine">':"<li>",b+='<div class="jam-chat-user">',b+='<img src="'+window.WS_HEADURL+'">',b+="<span>",b+=a["fromUserId"]==window.WS_UID?"<i>"+getNowFormatDate()+"</i>"+a["username"]+" </span>":a["username"]+"<i>"+getNowFormatDate()+"</i></span>",b+='</div><div class="jam-chat-text">'+a["message"]+"</div></li>",$("#jam_chat_message_list").append(b),$("#jam_chat_message").animate({scrollTop:$("#jam_chat_message").prop("scrollHeight")},1e3),$("#jam_chat_sbox").is(":hidden")||$("#jam_chat_sbox").addClass("notice-shake")}function updateMemberCount(a){$("#jam_chat_member_count").text(a),$("#jam_chat_member_count_show").text(a)}function addMember(a){var b="";b+='<li id="member_'+a["uid"]+'"><img src="'+window.WS_HEADURL+'"><span>'+a["username"]+"</span><p>"+a["city"]+"</p></li>",$("#jam_chat_member_list_ul").append(b),updateMemberCount(a["memberCount"])}function addMemberList(a,b){var e,c="",d=[];for(e in a)d=a[e],c+='<li id="member_'+d["uid"]+'"><img src="'+window.WS_HEADURL+'"><span>'+d["username"]+"</span><p>"+d["city"]+"</p></li>";$("#jam_chat_member_list_ul").append(c),$("#member_"+window.WS_UID).addClass("member-self"),updateMemberCount(b)}function flicker(){var a=0,b=0,c=$("#jam_chat_sbox"),d=setInterval(function(){b?(c.removeClass("remind-yellow"),b=0):(c.addClass("remind-yellow"),b=1),a>=3&&(c.addClass("remind-yellow"),clearInterval(d)),a++},500)}var ws,connected,reconnectFlag,heartCheck;!function(){$("#jam_chat_sbox").click(function(){$("#jam_chat_main").show(),$(this).hide(),$(this).removeClass("notice-shake")}),$("#jam_chat_main_close").click(function(){$("#jam_chat_sbox").show(),$("#jam_chat_main").hide()}),$(".chat-choose li").click(function(){$(this).addClass("cur"),$(this).siblings().removeClass("cur");var a=$(this).attr("data-type");"message"==a?($("#jam_chat_content").show(),$("#jam_chat_member").hide()):($("#jam_chat_member").show(),$("#jam_chat_content").hide())})}(),connected=!1,reconnectFlag=!1,createWebSocket(),heartCheck={timeout:3e4,timeoutObj:null,serverTimeoutObj:null,reset:function(){return clearTimeout(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this},start:function(){var a=this;this.timeoutObj=setTimeout(function(){var b={};b["event"]="keepalive",ws.send(JSON.stringify(b)),a.serverTimeoutObj=setTimeout(function(){ws.close()},a.timeout)},this.timeout)}},$("#jam_chat_send_btn").click(function(){var a,b;return 0==window.WS_UID?(showMsg("请先登录"),!1):connected?(a=$("#jam_chat_message_content").val(),""==$.trim(a)?(showMsg("请先输入要发送的内容"),!1):(b={},b["uid"]=window.WS_UID,b["event"]="sendMsgAll",b["content"]=a,ws.send(JSON.stringify(b)),$("#jam_chat_message_content").val(""),void 0)):(showMsg("未链接到服务器！刷新页面试试~"),console.log("Client is not connected!"),!1)});